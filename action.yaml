name: 'Run as user'
description: 'Runs a set of commands as another user, in their shell environment'
inputs:
  commands:
    description: 'Commands to run'
    required: true
  user:
    description: 'User in whose shell environment these commands are executed'
    required: true
  shell:
    description: 'Which shell to use; bash by default'
    required: true
    default: 'bash'
  keyname:
    description: 'Filename root for SSH key pair'
    required: false
    default: 'rua_sshkey'

runs:
  using: "composite"
  steps:
    - id: install-key
      run: |
        HOME_DIR=$(eval echo "~${{ inputs.user }}") ; \
        SSH_DIR="$HOME_DIR/.ssh" ; \
        KEYFILE="$SSH_DIR/${{ inputs.keyname }}" ; \
        echo "key=$KEYFILE" >> $GITHUB_OUTPUT
        if [ ! -e $KEYFILE ]; then
          sudo mkdir -p $SSH_DIR ; \
          ssh-keygen -b 1024 -t rsa -f $KEYFILE -q -N "" ; \
          sudo cat $KEYFILE.pub >> $SSH_DIR/authorized_keys ; \
          GROUP=$(id -gn ${{ inputs.user }}) ;\
          sudo chown -R ${{ inputs.user }}:${GROUP} $SSH_DIR
          sudo chmod 700 $KEYFILE
        fi
      shell: bash
    - run: |
        sudo -u ${{ inputs.user }} ssh -o StrictHostKeyChecking=no -i ${{ steps.install-key.outputs.key }} ${{ inputs.user }}@localhost ${{ inputs.shell }} -c \"'${{ inputs.commands }}'\"
      shell: bash
